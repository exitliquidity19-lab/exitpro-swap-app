<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>EXIT PRO Swap - Neon Edition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
  <script src="https://unpkg.com/bs58@latest/index.js"></script>
  <style>
    :root {
      --neon-green: #00ff9d;
      --deep-black: #050505;
    }
    body { 
      background: radial-gradient(circle at center, #0a2a1f 0%, #050505 100%); 
      color: #e0fef4; 
      margin:0; padding:0; 
      min-height:100vh; 
      font-family: 'Segoe UI', system-ui, sans-serif;
      overflow-x: hidden;
    }
    .glass-card {
      background: rgba(0, 20, 15, 0.85);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(0, 255, 157, 0.3);
      border-radius: 24px;
      box-shadow: 0 0 30px rgba(0, 255, 157, 0.15);
    }
    .neon-green-text { color: var(--neon-green); text-shadow: 0 0 10px rgba(0, 255, 157, 0.6); }
    .swap-btn {
      background: var(--neon-green);
      color: #000;
      box-shadow: 0 0 20px rgba(0, 255, 157, 0.4);
      transition: all 0.3s ease;
    }
    .swap-btn:hover:not(:disabled) { 
      box-shadow: 0 0 30px rgba(0, 255, 157, 0.8);
      transform: scale(1.02);
    }
    .connect-btn {
      border: 1px solid var(--neon-green);
      color: var(--neon-green);
      background: rgba(0, 255, 157, 0.1);
      box-shadow: inset 0 0 10px rgba(0, 255, 157, 0.1);
    }
    .token-select {
      background: rgba(0, 40, 30, 0.6);
      border: 1px solid rgba(0, 255, 157, 0.4);
      color: var(--neon-green);
    }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <nav class="fixed top-0 w-full glass-card z-50 px-4 py-4 flex justify-between items-center border-b border-[#00ff9d]/20">
    <div class="flex items-center gap-3">
      <img src="assets/logo.png" alt="EXIT PRO" class="h-10 w-10 rounded-full object-cover border-2 border-[#00ff9d]" onerror="this.src='https://via.placeholder.com/40/00ff9d/000?text=E';" />
      <span class="text-2xl font-black neon-green-text">EXIT PRO</span>
    </div>
    <button id="connect-btn" class="px-5 py-2 connect-btn rounded-full font-black transition text-xs uppercase tracking-widest">
      Connect Wallet
    </button>
  </nav>

  <main class="flex-1 flex items-center justify-center pt-28 pb-12 px-4">
    <div class="glass-card p-8 w-full max-w-md border-t-4 border-t-[#00ff9d]">
      <h1 class="text-3xl font-black text-center neon-green-text mb-10 uppercase tracking-[0.2em]">Swap</h1>

      <div class="mb-6">
        <div class="flex justify-between text-[10px] font-black text-[#00ff9d]/70 mb-2 uppercase tracking-widest">
          <span>You Pay</span>
          <span id="from-balance">Balance: 0.00 SOL</span>
        </div>
        <div class="flex items-center gap-3 bg-black/60 border border-[#00ff9d]/30 rounded-2xl p-5 focus-within:border-[#00ff9d] transition-all">
          <input id="from-amount" type="number" placeholder="0.0" class="flex-1 bg-transparent outline-none text-3xl text-white font-bold" />
          <select id="from-token" class="token-select rounded-xl px-3 py-2 font-black outline-none text-sm">
            <option value="So11111111111111111111111111111111111111112">SOL</option>
            <option value="EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v">USDC</option>
          </select>
        </div>
      </div>

      <div class="flex justify-center -my-7 z-10 relative">
        <div class="bg-[#050505] border-2 border-[#00ff9d] p-3 rounded-full shadow-[0_0_15px_rgba(0,255,157,0.5)]">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 neon-green-text" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
          </svg>
        </div>
      </div>

      <div class="mb-8 mt-5">
        <div class="flex justify-between text-[10px] font-black text-[#00ff9d]/70 mb-2 uppercase tracking-widest">
          <span>You Receive</span>
          <span id="to-balance">Balance: 0.00 USDC</span>
        </div>
        <div class="flex items-center gap-3 bg-black/60 border border-[#00ff9d]/30 rounded-2xl p-5">
          <input id="to-amount" type="text" placeholder="0.0" readonly class="flex-1 bg-transparent outline-none text-3xl text-white/40 font-bold" />
          <select id="to-token" class="token-select rounded-xl px-3 py-2 font-black outline-none text-sm">
            <option value="EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v">USDC</option>
            <option value="So11111111111111111111111111111111111111112">SOL</option>
          </select>
        </div>
      </div>

      <div class="bg-black/20 rounded-xl p-4 mb-8 border border-[#00ff9d]/10 text-[10px] font-bold uppercase tracking-wider space-y-3">
        <div class="flex justify-between text-[#00ff9d]/50">
          <span>Price Impact</span>
          <span id="price-impact" class="text-white">--</span>
        </div>
        <div class="flex justify-between text-[#00ff9d]/50">
          <span>Slippage</span>
          <span class="text-white">0.5%</span>
        </div>
        <div class="flex justify-between text-[#00ff9d]/50">
          <span>Route</span>
          <span id="route" class="text-white truncate max-w-[150px]">--</span>
        </div>
      </div>

      <button id="swap-btn" disabled class="w-full swap-btn font-black text-xl py-5 rounded-2xl uppercase tracking-[0.2em] disabled:opacity-20 disabled:grayscale transition-all">
        Execute Swap
      </button>

      <div id="status" class="mt-6 text-center text-[10px] font-black text-white uppercase tracking-widest min-h-[1.5rem] opacity-80"></div>
    </div>
  </main>

  <script>
    const JUPITER_API = 'https://quote-api.jup.ag/v6';
    const REFERRAL_ACCOUNT = '9HdCWUEgEajC47Hni4YvUFdoCzvncsMscXixMsmhNYmH';
    const REFERRAL_FEE_BPS = 50;
    const RPC_ENDPOINT = 'https://api.mainnet-beta.solana.com';

    let walletPublicKey = null;
    let currentWallet = null;
    let quoteData = null;
    let debounceTimer = null;

    const connectBtn = document.getElementById('connect-btn');

    // Fungsi Connect & Disconnect
    connectBtn.onclick = async () => {
      // Jika sudah connect, klik tombol akan disconnect
      if (walletPublicKey) {
        if (confirm("Disconnect wallet?")) {
          disconnectWallet();
        }
        return;
      }

      let wallet = window.backpack || window.solflare || window.solana;

      if (!wallet) {
        alert('No wallet detected! Use Solflare/Phantom Browser.');
        return;
      }

      try {
        const resp = await wallet.connect();
        const pubKeyObj = resp?.publicKey || wallet.publicKey;
        
        walletPublicKey = pubKeyObj.toString();
        currentWallet = wallet;

        // Update UI Button
        const shortKey = `${walletPublicKey.slice(0,4)}...${walletPublicKey.slice(-4)}`;
        connectBtn.textContent = shortKey;
        connectBtn.classList.add('bg-[#00ff9d]', 'text-black');
        
        document.getElementById('swap-btn').disabled = false;
        document.getElementById('status').textContent = 'CONNECTED TO SOLANA';
        
        // Langsung fetch saldo pas connect
        await refreshAllBalances();
      } catch (err) {
        console.error(err);
        alert('Connect failed!');
      }
    };

    function disconnectWallet() {
      walletPublicKey = null;
      currentWallet = null;
      connectBtn.textContent = 'Connect Wallet';
      connectBtn.classList.remove('bg-[#00ff9d]', 'text-black');
      document.getElementById('swap-btn').disabled = true;
      document.getElementById('from-balance').textContent = 'Balance: 0.00 SOL';
      document.getElementById('to-balance').textContent = 'Balance: 0.00 USDC';
      document.getElementById('status').textContent = 'DISCONNECTED';
    }

    // Fungsi Ambil Saldo Real-time
    async function getBalance(mintAddress) {
      if (!walletPublicKey) return 0;
      try {
        const connection = new solanaWeb3.Connection(RPC_ENDPOINT);
        const pubKey = new solanaWeb3.PublicKey(walletPublicKey);

        // Jika Native SOL
        if (mintAddress === 'So11111111111111111111111111111111111111112') {
          const bal = await connection.getBalance(pubKey);
          return (bal / 1e9).toFixed(4);
        } 
        // Jika SPL Token (USDC, dll)
        else {
          const tokenAccounts = await connection.getParsedTokenAccountsByOwner(pubKey, {
            mint: new solanaWeb3.PublicKey(mintAddress)
          });
          if (tokenAccounts.value.length > 0) {
            return tokenAccounts.value[0].account.data.parsed.info.tokenAmount.uiAmount.toFixed(2);
          }
          return "0.00";
        }
      } catch (e) {
        console.error("Fetch Balance Error:", e);
        return "0.00";
      }
    }

    async function refreshAllBalances() {
      const fromMint = document.getElementById('from-token').value;
      const toMint = document.getElementById('to-token').value;
      
      const balFrom = await getBalance(fromMint);
      const balTo = await getBalance(toMint);
      
      const fromSymbol = document.getElementById('from-token').options[document.getElementById('from-token').selectedIndex].text;
      const toSymbol = document.getElementById('to-token').options[document.getElementById('to-token').selectedIndex].text;

      document.getElementById('from-balance').textContent = `Balance: ${balFrom} ${fromSymbol}`;
      document.getElementById('to-balance').textContent = `Balance: ${balTo} ${toSymbol}`;
    }

    // Jupiter Quote Logic
    async function getQuote() {
      const amountInput = document.getElementById('from-amount').value;
      if (!amountInput || amountInput <= 0 || !walletPublicKey) return;

      const inputMint = document.getElementById('from-token').value;
      const outputMint = document.getElementById('to-token').value;
      const decimals = inputMint === 'So11111111111111111111111111111111111111112' ? 1e9 : 1e6;
      const amount = Math.floor(amountInput * decimals);

      document.getElementById('status').textContent = 'ROUTING...';

      try {
        const url = `${JUPITER_API}/quote?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amount}&slippageBps=50&referralFeeBps=${REFERRAL_FEE_BPS}&referralAccount=${REFERRAL_ACCOUNT}`;
        const res = await fetch(url);
        quoteData = await res.json();

        const outDecimals = outputMint === 'So11111111111111111111111111111111111111112' ? 1e9 : 1e6;
        document.getElementById('to-amount').value = (quoteData.outAmount / outDecimals).toFixed(4);
        document.getElementById('price-impact').textContent = quoteData.priceImpactPct ? (quoteData.priceImpactPct * 100).toFixed(2) + '%' : '--';
        document.getElementById('route').textContent = quoteData.routePlan?.map(r => r.ammLabel).join(' > ') || '--';
        document.getElementById('status').textContent = 'QUOTED';
      } catch (err) {
        document.getElementById('status').textContent = 'ERROR FETCHING QUOTE';
      }
    }

    // Listeners
    document.getElementById('from-amount').addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(getQuote, 800);
    });

    document.getElementById('from-token').addEventListener('change', () => {
      refreshAllBalances();
      getQuote();
    });

    document.getElementById('to-token').addEventListener('change', () => {
      refreshAllBalances();
      getQuote();
    });

    // Swap Execution
    document.getElementById('swap-btn').onclick = async () => {
      if (!walletPublicKey || !quoteData || !currentWallet) return;
      document.getElementById('status').textContent = 'AUTHORIZING...';

      try {
        const res = await fetch(`${JUPITER_API}/swap`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            quoteResponse: quoteData,
            userPublicKey: walletPublicKey,
            wrapAndUnwrapSol: true,
            referralAccount: REFERRAL_ACCOUNT,
            referralFeeBps: REFERRAL_FEE_BPS,
            dynamicComputeUnitLimit: true,
            prioritizationFeeLamports: 'auto'
          })
        });

        const { swapTransaction } = await res.json();
        const txBuf = Uint8Array.from(atob(swapTransaction), c => c.charCodeAt(0));
        const transaction = solanaWeb3.VersionedTransaction.deserialize(txBuf);

        const signedTx = await currentWallet.signTransaction(transaction);
        const connection = new solanaWeb3.Connection(RPC_ENDPOINT, 'confirmed');
        const txid = await connection.sendRawTransaction(signedTx.serialize(), { skipPreflight: true });

        document.getElementById('status').innerHTML = `<a href="https://solscan.io/tx/${txid}" target="_blank" class="text-[#00ff9d]">SUCCESS! CLICK TO VIEW</a>`;
        
        // Refresh saldo setelah sukses
        setTimeout(refreshAllBalances, 3000);
      } catch (err) {
        document.getElementById('status').textContent = 'TRANSACTION FAILED';
      }
    };
  </script>
</body>
</html>

 
